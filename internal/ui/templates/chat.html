{{define "chat_content"}}
<main class="content">
    <section class="message-history" id="message-history">
        <div id="messages-container" class="messages-container" data-chat-id="{{.ChatID}}">
          <div class="message-intro">
            <h2>{{.ChatName}} with {{.AgentName}}</h2>
              {{if eq (len .Messages) 0}}
                <p>How can I help you today?</p>
              {{end}}
            </div>

            <!-- Group messages by conversation session (user + responses) -->
            {{$userMsgIndex := 0}}
            {{$inSession := false}}

            {{range $i, $msg := .Messages}}
              <!-- Start a new session when we see a user message -->
              {{if and (eq $msg.Role "user") (not $inSession)}}
                <div id="message-session-{{$userMsgIndex}}" class="message-session">
                {{$inSession = true}}
                {{$userMsgIndex = add $userMsgIndex 1}}
              {{end}}

              <!-- Render the message based on role -->
              {{if eq $msg.Role "user"}}
                <div class="message user-message">
                  <div class="message-content">{{renderMarkdown $msg.Content}}</div>
                </div>
              {{else if eq $msg.Role "assistant"}}
                <div class="message agent-message">
                  <div class="message-content">{{renderMarkdown $msg.Content}}</div>
                </div>
              {{else}}
                <div class="message tool-message">
                  <div class="message-content">{{renderMarkdown $msg.Content}}</div>
                </div>
              {{end}}

              <!-- End a session when we see the next user message or end of messages -->
              {{if or (and (lt (add $i 1) (len $.Messages)) (eq (index $.Messages (add $i 1)).Role "user")) (eq $i (sub (len $.Messages) 1))}}
                {{if $inSession}}
                  </div>
                  {{$inSession = false}}
                {{end}}
              {{end}}
            {{end}}

            <!-- Placeholder for next message session -->
            <div id="next-message-session"></div>
        </div>
    </section>
    <section class="message-input" id="message-input-section">
        <form id="message-form" class="message-form"
              hx-post="/chats/{{.ChatID}}/messages"
              hx-target="#next-message-session"
              hx-swap="outerHTML"
              hx-indicator="#thinking-indicator"
              hx-trigger="submit, keydown[ctrlKey || metaKey && key == 'Enter']"
              hx-on::after-request="this.reset(); document.getElementById('message-history').scrollTop = document.getElementById('message-history').scrollHeight;">
            <input type="hidden" name="chat_id" value="{{.ChatID}}">
            <textarea name="message" id="message-input" placeholder="Type your message..." rows="3"></textarea>
            <button type="submit" id="send-button">
              <span class="htmx-indicator" id="thinking-indicator">
                Thinking <span class="spinner"></span>
              </span>
              <span class="htmx-indicator-hide">
                <i class="fas fa-paper-plane"></i> Send
              </span>
            </button>
        </form>
    </section>
</main>
<style>
  .htmx-request .htmx-indicator {
    display: inline;
  }
  .htmx-request .htmx-indicator-hide {
    display: none;
  }
  .htmx-indicator {
    display: none;
  }
</style>
{{end}}
