{{define "chat_content"}}
<main class="content">
    <section class="message-history" id="message-history">
        <div id="messages-container" class="messages-container" data-chat-id="{{.ChatID}}">
            <div class="message-intro">
                {{if eq (len .Messages) 0}}
                    <p>How can I help you today?</p>
                {{end}}
            </div>

            <!-- Group messages by conversation session (user + responses) -->
            {{$userMsgIndex := 0}}
            {{$inSession := false}}

            {{range $i, $msg := .Messages}}
                <!-- Start a new session when we see a user message -->
                {{if and (eq $msg.Role "user") (not $inSession)}}
                    <div id="message-session-{{$userMsgIndex}}" class="message-session">
                    {{$inSession = true}}
                    {{$userMsgIndex = add $userMsgIndex 1}}
                {{end}}

                <!-- Render the message based on role -->
                {{if eq $msg.Role "user"}}
                    <div class="message user-message">
                        <div class="message-content">{{renderMarkdown $msg.Content}}</div>
                    </div>
                {{else if eq $msg.Role "assistant"}}
                    <div class="message agent-message">
                        <div class="message-content">
                            {{renderMarkdown $msg.Content}}  <!-- Existing text -->
                        </div>
                    </div>
                   {{else if eq $msg.Role "tool"}}
                       <div class="message tool-message">
                            {{range $msg.ToolCallEvents}}
                              <div class="tool-event">
                                <div class="tool-name">{{formatToolName .ToolName .Arguments}}</div>
                                <div class="tool-result">{{formatToolResult .ToolName .Result .Diff .Arguments}}</div>
                               {{if .Error}}
                                 <div class="tool-error">{{.Error}}</div>
                               {{end}}
                             </div>
                           {{end}}
                       </div>
                 {{else}}
                     <div class="message system-message">
                         <div class="message-content">{{renderMarkdown $msg.Content}}</div>
                     </div>
                 {{end}}

                <!-- End a session when we see the next user message or end of messages -->
                {{if or (and (lt (add $i 1) (len $.Messages)) (eq (index $.Messages (add $i 1)).Role "user")) (eq $i (sub (len $.Messages) 1))}}
                    {{if $inSession}}
                        </div>
                        {{$inSession = false}}
                    {{end}}
                {{end}}
            {{end}}

            <!-- Placeholder for next message session -->
            <div id="next-message-session"></div>
        </div>
    </section>
    <section class="message-input" id="message-input-section">
        {{template "message_controls" .}}
    </section>

    <!-- Hidden element for title polling -->
    <div id="title-poller"
         hx-get="/chats/{{.ChatID}}/title"
         hx-trigger="load, every 3s"
         hx-swap="none"
         hx-on::after-request="updateTitleIfChanged(event)">
    </div>
</main>

<style>
.btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 4px;
}

.btn-outline {
    background: transparent;
    color: #007bff;
    border-color: #007bff;
}

.btn-outline:hover {
    background: #007bff;
    color: white;
}

.btn-primary {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border-color: #6c757d;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 11px;
}
</style>

<script>
function updateTitleIfChanged(event) {
    if (event.detail && event.detail.xhr) {
        try {
            const response = JSON.parse(event.detail.xhr.responseText);
            const newTitle = response.title;
            const currentTitle = document.title;

            // Extract current chat title from page title (format: "Chat Title - AI Agents")
            const titleParts = currentTitle.split(' - ');
            const currentChatTitle = titleParts.length > 1 ? titleParts[0] : 'Chat';

            if (newTitle && newTitle !== currentChatTitle) {
                // Update page title
                document.title = newTitle + ' - AI Agents';

                // Update header title if it exists
                const headerTitle = document.querySelector('h1');
                if (headerTitle && headerTitle.textContent === currentChatTitle) {
                    headerTitle.textContent = newTitle;
                }

                // Trigger sidebar refresh
                htmx.trigger('body', 'refreshChats');

                // Stop polling by removing the poller element
                const poller = document.getElementById('title-poller');
                if (poller) {
                    poller.remove();
                }
            }
        } catch (e) {
            console.warn('Failed to parse title response:', e);
        }
    }
}
</script>
{{end}}