{{define "chat_content"}}
<main class="content">
    <section class="chat-header" style="background: #333; padding: 10px 0; border-bottom: 1px solid #444;">
        <div class="chat-info">
            <div class="agent-info">
                <i class="fas fa-robot" style="color: #fff;"></i>
                <span style="color: #fff;">Agent: {{.AgentName}}</span>
                <button class="btn btn-sm btn-primary" onclick="showAgentSwitcher()">
                    <i class="fas fa-exchange-alt" style="color: #fff;"></i> Switch
                </button>
            </div>
            <div class="model-info">
                <i class="fas fa-brain" style="color: #fff;"></i>
                <span style="color: #fff;">Model: {{.ModelName}}</span>
                <button class="btn btn-sm btn-primary" onclick="showModelSwitcher()">
                    <i class="fas fa-exchange-alt" style="color: #fff;"></i> Switch
                </button>
            </div>
        </div>
         <div id="agent-switcher" class="agent-switcher" style="display: none; background: #333; color: #fff; padding: 10px; border-radius: 4px;">
             <select id="agent-select" class="form-control form-control-sm">
                 <option value="">Select Agent</option>
                 {{range .AvailableAgents}}
                 <option value="{{.ID}}" {{if eq .ID $.CurrentAgentID}}selected{{end}}>{{.Name}}</option>
                 {{else}}
                 <option value="" disabled>No agents available</option>
                 {{end}}
             </select>
             <button class="btn btn-sm btn-primary" onclick="switchAgent()">Switch</button>
             <button class="btn btn-sm btn-secondary" onclick="hideAgentSwitcher()">Cancel</button>
         </div>
         <div id="model-switcher" class="model-switcher" style="display: none; background: #333; color: #fff; padding: 10px; border-radius: 4px;">
             <select id="model-select" class="form-control form-control-sm">
                 <option value="">Select Model</option>
                 {{range .AvailableModels}}
                 <option value="{{.ID}}" {{if eq .ID $.CurrentModelID}}selected{{end}}>{{.Name}}</option>
                 {{else}}
                 <option value="" disabled>No models available</option>
                 {{end}}
             </select>
             <button class="btn btn-sm btn-primary" onclick="switchModel()">Switch</button>
             <button class="btn btn-sm btn-secondary" onclick="hideModelSwitcher()">Cancel</button>
         </div>
    </section>
    <section class="message-history" id="message-history">
        <div id="messages-container" class="messages-container" data-chat-id="{{.ChatID}}">
            <div class="message-intro">
                {{if eq (len .Messages) 0}}
                    <p>How can I help you today?</p>
                {{end}}
            </div>

            <!-- Group messages by conversation session (user + responses) -->
            {{$userMsgIndex := 0}}
            {{$inSession := false}}

            {{range $i, $msg := .Messages}}
                <!-- Start a new session when we see a user message -->
                {{if and (eq $msg.Role "user") (not $inSession)}}
                    <div id="message-session-{{$userMsgIndex}}" class="message-session">
                    {{$inSession = true}}
                    {{$userMsgIndex = add $userMsgIndex 1}}
                {{end}}

                <!-- Render the message based on role -->
                {{if eq $msg.Role "user"}}
                    <div class="message user-message">
                        <div class="message-content">{{renderMarkdown $msg.Content}}</div>
                    </div>
                {{else if eq $msg.Role "assistant"}}
                    <div class="message agent-message">
                        <div class="message-content">
                            {{renderMarkdown $msg.Content}}  <!-- Existing text -->
                        </div>
                    </div>
                   {{else if eq $msg.Role "tool"}}
                       <div class="message tool-message">
                            {{range $msg.ToolCallEvents}}
                              <div class="tool-event">
                                <div class="tool-name">{{formatToolName .ToolName .Arguments}}</div>
                                <div class="tool-result">{{formatToolResult .ToolName .Result .Diff .Arguments}}</div>
                               {{if .Error}}
                                 <div class="tool-error">{{.Error}}</div>
                               {{end}}
                             </div>
                           {{end}}
                       </div>
                 {{else}}
                     <div class="message system-message">
                         <div class="message-content">{{renderMarkdown $msg.Content}}</div>
                     </div>
                 {{end}}

                <!-- End a session when we see the next user message or end of messages -->
                {{if or (and (lt (add $i 1) (len $.Messages)) (eq (index $.Messages (add $i 1)).Role "user")) (eq $i (sub (len $.Messages) 1))}}
                    {{if $inSession}}
                        </div>
                        {{$inSession = false}}
                    {{end}}
                {{end}}
            {{end}}

            <!-- Placeholder for next message session -->
            <div id="next-message-session"></div>
        </div>
    </section>
    <section class="message-input" id="message-input-section">
        {{template "message_controls" .}}
    </section>
</main>

<style>
.chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-info {
    display: flex;
    gap: 30px;
    align-items: center;
}

.agent-info, .model-info {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #666;
}

.agent-info i, .model-info i {
    color: #007bff;
}

.model-info {
    position: relative;
}

.agent-switcher, .model-switcher {
    margin-top: 10px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-width: 250px;
}

.model-switcher select {
    margin-bottom: 8px;
    width: 100%;
}

.btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 4px;
}

.btn-outline {
    background: transparent;
    color: #007bff;
    border-color: #007bff;
}

.btn-outline:hover {
    background: #007bff;
    color: white;
}

.btn-primary {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border-color: #6c757d;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 11px;
}
</style>

<script>
function showAgentSwitcher() {
    document.getElementById('agent-switcher').style.display = 'block';
}

function hideAgentSwitcher() {
    document.getElementById('agent-switcher').style.display = 'none';
}

function switchAgent() {
    const agentId = document.getElementById('agent-select').value;
    if (!agentId) {
        alert('Please select an agent first');
        return;
    }

    const chatId = document.querySelector('[data-chat-id]').getAttribute('data-chat-id');

    fetch(`/chats/${chatId}/agent`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ agent_id: agentId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show new agent
        } else {
            alert('Failed to switch agent: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Failed to switch agent: ' + error.message);
    });
}

function showModelSwitcher() {
    document.getElementById('model-switcher').style.display = 'block';
}

function hideModelSwitcher() {
    document.getElementById('model-switcher').style.display = 'none';
}

function switchModel() {
    const modelId = document.getElementById('model-select').value;
    if (!modelId) {
        alert('Please select a model first');
        return;
    }

    const chatId = document.querySelector('[data-chat-id]').getAttribute('data-chat-id');

    fetch(`/chats/${chatId}/model`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ model_id: modelId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh to show new model
        } else {
            alert('Failed to switch model: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Failed to switch model: ' + error.message);
    });
}
</script>
{{end}}
